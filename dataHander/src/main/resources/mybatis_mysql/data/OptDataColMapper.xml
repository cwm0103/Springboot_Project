<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bom.domain.data.dao.OptDataColMapper">
  <resultMap id="BaseResultMap" type="com.bom.domain.data.model.OptDataCol">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="project_id" jdbcType="VARCHAR" property="projectId" />
    <result column="code" jdbcType="VARCHAR" property="code" />
    <result column="cur_value" jdbcType="DOUBLE" property="curValue" />
    <result column="col_time" jdbcType="TIMESTAMP" property="colTime" />
    <result column="sys_time" jdbcType="TIMESTAMP" property="sysTime" />
    <result column="quantity" jdbcType="INTEGER" property="quantity" />
    <result column="data_type" jdbcType="VARCHAR" property="dataType" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from opt_data_col
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.bom.domain.data.model.OptDataCol">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->

    insert into opt_data_col ( project_id, code,
      cur_value, col_time, sys_time, 
      quantity, data_type)
    values ( #{projectId,jdbcType=VARCHAR}, #{code,jdbcType=VARCHAR},
      #{curValue,jdbcType=DOUBLE}, #{colTime,jdbcType=TIMESTAMP}, #{sysTime,jdbcType=TIMESTAMP}, 
      #{quantity,jdbcType=INTEGER}, #{dataType,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.bom.domain.data.model.OptDataCol">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update opt_data_col
    set project_id = #{projectId,jdbcType=VARCHAR},
      code = #{code,jdbcType=VARCHAR},
      cur_value = #{curValue,jdbcType=DOUBLE},
      col_time = #{colTime,jdbcType=TIMESTAMP},
      sys_time = #{sysTime,jdbcType=TIMESTAMP},
      quantity = #{quantity,jdbcType=INTEGER},
      data_type = #{dataType,jdbcType=VARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select id, project_id, code, cur_value, col_time, sys_time, quantity, data_type
    from opt_data_col
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select id, project_id, code, cur_value, col_time, sys_time, quantity, data_type
    from opt_data_col
  </select>

  <insert id="insertDataColBatch" useGeneratedKeys="true" parameterType="java.util.List">
    insert into opt_data_col ( project_id, code,
    cur_value, col_time, sys_time,quantity, data_type)
    values
    <foreach collection="dataColList" item="item" index="index" separator="," >
      ( #{item.projectId}, #{item.code},
      #{item.curValue}, #{item.colTime}, #{item.sysTime},
      #{item.quantity}, #{item.dataType})
    </foreach>
  </insert>


  <select id="selectDataColTop300" resultMap="BaseResultMap">
    select * from opt_data_col order by id desc limit 300;
  </select>

  <select id="GetEnergyDataSummary" resultType="java.lang.Double">

   SELECT ifnull(sum(cur_value),0) as totalValue FROM opt_data_col
   where code=#{code} and project_id=#{project_id};
   /*code='m340_RTU_GIQ504_FLOW_EC_PV_CX_1016' and project_id=1016;*/


  </select>

  <select id="GetDayDiffValueFromDataCol" resultType="java.lang.Double">

SELECT
    CASE
        WHEN SUM(IFNULL(t2.cur_value, 0) - IFNULL(t1.cur_value, 0)) > 0 THEN SUM(IFNULL(t2.cur_value, 0) - IFNULL(t1.cur_value, 0))
        ELSE 0
    END
FROM
    (SELECT
        cur_value
    FROM
        datadb.opt_data_col
    WHERE
        project_id = #{siteId}
            AND code = #{code}
            AND sys_time = #{stime}) t1
        JOIN
    (SELECT
        cur_value
    FROM
        datadb.opt_data_col
    WHERE
        project_id =  #{siteId}
            AND code = #{code}
            AND sys_time =#{etime}) t2
  </select>

  <select id="findByMi" resultMap="BaseResultMap">
      select DISTINCT project_id,code,cur_value,col_time,sys_time from opt_data_col
      where sys_time = STR_TO_DATE(#{timeStr},'%Y-%m-%d %H:%i:%s')
  </select>

   <select id="findByCodeAndMi" resultType="com.bom.domain.data.model.OptDataCol" >
       select DISTINCT project_id as projectId,code,cur_value as curValue,col_time as colTime from opt_data_col where
       project_id=#{projectId}
       and sys_time = STR_TO_DATE(#{timeStr},'%Y-%m-%d %H:%i:%s')
       and code=#{code}
   </select>

    <select id="getModelByProjectIdAndTime" resultMap="BaseResultMap" >
        select * from opt_data_col where
        project_id=#{projectId}
        and sys_time = STR_TO_DATE(#{sysTime},'%Y-%m-%d %H:%i:%s')

    </select>

</mapper>